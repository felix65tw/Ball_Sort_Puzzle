<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ball Sort - Professional Edition</title>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --tile-bg: #16213e;
            --accent: #2ed573;
            --text-main: #e0e0e0;
            --ball-size: 40px; 
            --tube-w: 54px;
            --tube-h: 210px; 
            --btn-undo: #3498db;
            --btn-extra: #f39c12;
            --btn-reset: #e74c3c;
            --btn-sound: #8e44ad;
            --btn-help: #95a5a6;
            --btn-disabled: #334155;
            --highlight: #f1c40f;
        }

        body {
            font-family: 'Clear Sans', 'Segoe UI', Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0; display: flex; flex-direction: column; align-items: center;
            height: 100vh; color: var(--text-main); overflow: hidden;
            touch-action: manipulation;
        }

        .score-container {
            margin-top: 10px; display: flex; flex-wrap: wrap;
            justify-content: center; gap: 6px; width: 95%; max-width: 600px;
        }
        .stat-tile {
            background: var(--tile-bg); min-width: 60px; padding: 10px 4px;
            border-radius: 6px; text-align: center; flex: 1;
            border: 1px solid rgba(255,255,255,0.08); cursor: pointer;
        }
        .stat-label { display: block; font-size: 9px; font-weight: bold; color: #94a3b8; text-transform: uppercase; margin-bottom: 2px; pointer-events: none; }
        .stat-val { display: block; font-size: 16px; font-weight: bold; color: var(--highlight); pointer-events: none; }

        .difficulty-display {
            margin-top: 12px; padding: 8px 25px; background: #2c3e50;
            border-radius: 6px; font-weight: bold; color: #eee;
            cursor: pointer; border: 1px solid rgba(255,255,255,0.2); font-size: 0.9rem;
            text-transform: uppercase;
        }

        #game-container {
            display: flex; flex-wrap: wrap; justify-content: center;
            align-content: center; gap: 8px; padding: 10px;
            flex-grow: 1; width: 100%; max-width: 850px;
        }
        .tube {
            width: var(--tube-w); height: var(--tube-h);
            border: 3px solid rgba(255,255,255,0.25); border-top: none;
            border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;
            display: flex; flex-direction: column-reverse; align-items: center;
            /* 調整 padding-bottom 讓球更靠近底部 */
            padding-bottom: 4px; 
            cursor: pointer; background: rgba(255, 255, 255, 0.08); transition: 0.2s;
            transform: translateY(-10px);
        }
        .tube.selected { transform: translateY(-25px); border-color: var(--highlight); box-shadow: 0 0 15px rgba(241, 196, 15, 0.3); }

        .ball {
            width: var(--ball-size); height: var(--ball-size); border-radius: 50%;
            /* 降低間距讓球更密集並靠近瓶底 */
            margin-bottom: 1px; 
            background: radial-gradient(circle at 12px 12px, var(--color-light), #000);
            box-shadow: inset -2px -2px 5px rgba(0,0,0,0.4), 0 3px 6px rgba(0,0,0,0.3); flex-shrink: 0;
        }
        .c-1 { --color-light: #ff3333; }
        .c-2 { --color-light: #3399ff; }
        .c-3 { --color-light: #2ecc71; }
        .c-4 { --color-light: #f1c40f; }
        .c-5 { --color-light: #9b59b6; }
        .c-6 { --color-light: #e67e22; }
        .c-7 { --color-light: #1abc9c; }
        .c-8 { --color-light: #ecf0f1; }

        .footer { display: flex; justify-content: center; gap: 4px; margin-bottom: 25px; width: 100%; max-width: 500px; }
        .footer button {
            width: 18%; height: 42px; border: none; color: white; font-weight: bold;
            border-radius: 6px; cursor: pointer; font-size: 0.65rem;
            text-transform: uppercase; transition: 0.1s;
        }

        .btn-undo { background: var(--btn-undo); }
        .btn-undo.disabled { background: var(--btn-disabled); cursor: default; }
        .btn-extra { background: var(--btn-extra); }
        .btn-reset { background: var(--btn-reset); }
        .btn-sound { background: var(--btn-sound); }
        .btn-help { background: var(--btn-help); }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 25, 0.95); z-index: 4000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .overlay-card { background: var(--tile-bg); padding: 25px; border-radius: 15px; width: 88%; max-width: 380px; text-align: center; border: 2px solid var(--accent); }
        .overlay-title { font-size: 1.8rem; font-weight: bold; margin-bottom: 15px; color: var(--accent); }

        .help-table { width: 100%; border-collapse: collapse; margin-top: 10px; color: #e0e0e0; font-size: 0.8rem; }
        .help-table th, .help-table td { padding: 10px 4px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .help-table th { color: #94a3b8; font-size: 0.7rem; }

        .diff-list { 
            display: grid; grid-template-columns: 1fr; gap: 8px; width: 220px; 
            background: #2c3e50; padding: 10px; border-radius: 8px;
        }
        .diff-item { 
            background: var(--tile-bg); padding: 12px; border-radius: 6px; 
            font-weight: bold; color: #eee; cursor: pointer; 
            text-align: center; font-size: 0.85rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .diff-item.active { border: 2px solid var(--highlight); color: var(--highlight); }

        .res-data-box { margin-bottom: 20px; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 12px; }
        .res-line { display: flex; justify-content: space-between; margin: 8px 0; color: #94a3b8; font-weight: bold; font-size: 0.85rem; }
        .res-line span:last-child { color: var(--highlight); }
        .res-btn { width: 100%; padding: 15px; background: var(--accent); border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; color: #1a1a2e; }
    </style>
</head>
<body>

    <div class="score-container">
        <div class="stat-tile" onclick="detectWinTrigger()"><span class="stat-label">Time</span><span id="timer" class="stat-val">00:00</span></div>
        <div class="stat-tile"><span class="stat-label">Moves</span><span id="moves" class="stat-val">0</span></div>
        <div class="stat-tile" id="ai-trigger" onclick="detectAiTrigger()"><span class="stat-label">Undo</span><span id="undo-now" class="stat-val">0</span></div>
        <div class="stat-tile"><span class="stat-label">Extra</span><span id="extra-now" class="stat-val">0/1</span></div>
    </div>

    <div class="difficulty-display" onclick="toggleDiffMenu()"><span id="diff-now-label">ENTRY</span> ▾</div>
    
    <div id="game-container"></div>

    <div class="footer">
        <button id="undo-btn" class="btn-undo disabled" onclick="undoMove()">Undo</button>
        <button class="btn-extra" onclick="addExtraTube()">+Tube</button>
        <button class="btn-reset" onclick="initLevel(false)">Reset</button>
        <button id="sound-btn" class="btn-sound" onclick="toggleSound()">Sound</button>
        <button class="btn-help" onclick="toggleHelp()">Help</button>
    </div>

    <div id="help-overlay" class="overlay">
        <div class="overlay-card">
            <div class="overlay-title">GAME INFO</div>
            <table class="help-table">
                <thead><tr><th>RANK</th><th>COLORS</th><th>BALLS</th><th>TUBES</th></tr></thead>
                <tbody>
                    <tr><td>ENTRY</td><td>3</td><td>4</td><td>4</td></tr>
                    <tr><td>JUNIOR</td><td>4</td><td>4</td><td>5</td></tr>
                    <tr><td>INTERMEDIATE</td><td>5</td><td>4</td><td>6</td></tr>
                    <tr><td>ADVANCED</td><td>6</td><td>5</td><td>8</td></tr>
                    <tr><td>EXPERT</td><td>7</td><td>5</td><td>9</td></tr>
                    <tr><td>MASTER</td><td>8</td><td>5</td><td>10</td></tr>
                </tbody>
            </table>
            <button class="res-btn" style="margin-top:20px" onclick="toggleHelp()">CLOSE</button>
        </div>
    </div>

    <div id="diff-overlay" class="overlay">
        <div class="overlay-title" style="color:white; font-size: 1.2rem;">SELECT MODE</div>
        <div class="diff-list" id="diff-list"></div>
        <button style="margin-top: 15px; color:#94a3b8; background:none; border:none; cursor:pointer;" onclick="toggleDiffMenu()">CANCEL</button>
    </div>

    <div id="result-screen" class="overlay">
        <div class="overlay-card">
            <div class="overlay-title">SUCCESS!</div>
            <div class="res-data-box">
                <div class="res-line"><span>RANK</span><span id="res-diff"></span></div>
                <div class="res-line"><span>TIME</span><span id="res-time"></span></div>
                <div class="res-line"><span>MOVES</span><span id="res-moves"></span></div>
                <div class="res-line"><span>UNDO</span><span id="res-undo"></span></div>
                <div class="res-line"><span>EXTRA</span><span id="res-extra"></span></div>
            </div>
            <button onclick="closeResult()" class="res-btn">CONTINUE</button>
        </div>
    </div>

    <script>
        const DIFF_SETTINGS = [
            { id: 0, label: "ENTRY", color: 3, cap: 4, tubes: 4 },
            { id: 1, label: "JUNIOR", color: 4, cap: 4, tubes: 5 },
            { id: 2, label: "INTERMEDIATE", color: 5, cap: 4, tubes: 6 },
            { id: 3, label: "ADVANCED", color: 6, cap: 5, tubes: 8 },
            { id: 4, label: "EXPERT", color: 7, cap: 5, tubes: 9 },
            { id: 5, label: "MASTER", color: 8, cap: 5, tubes: 10 }
        ];

        let currentDiffIdx = 0, CAPACITY = 4, tubesData = [], history = [];
        let selectedIdx = null, moveCount = 0, undoTotal = 0, extraUsed = 0, seconds = 0;
        let timerInterval = null, isAnimating = false, soundEnabled = true, isAiMode = false;
        let undoClickCount = 0, timeClickCount = 0, lastAiClick = 0;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function initLevel(reset = true) {
            isAiMode = false; extraUsed = 0; history = []; selectedIdx = null;
            if(reset) { moveCount = 0; seconds = 0; undoTotal = 0; startTimer(); }
            const config = DIFF_SETTINGS[currentDiffIdx];
            CAPACITY = config.cap;
            let pool = [];
            for(let i=1; i<=config.color; i++) for(let j=0; j<CAPACITY; j++) pool.push(i);
            pool.sort(() => Math.random() - 0.5);
            tubesData = Array.from({length: config.tubes}, () => []);
            for(let i=0; i<pool.length; i++) tubesData[Math.floor(i/CAPACITY)].push(pool[i]);
            document.getElementById('diff-now-label').innerText = config.label;
            updateUI(); render();
        }

        function solveGameOptimized(initial) {
            const isWin = (s) => s.every(t => t.length === 0 || (t.length === CAPACITY && new Set(t).size === 1));
            const getHeuristic = (s) => {
                let score = 0;
                s.forEach(t => {
                    if (t.length === 0) score -= 100; 
                    else {
                        const uniqueColors = new Set(t).size;
                        score += (uniqueColors - 1) * 200;
                        score += (CAPACITY - t.length) * 10;
                    }
                });
                return score;
            };
            const serialize = (s) => JSON.stringify(s);
            let startNode = { s: initial, p: [], g: 0, h: getHeuristic(initial) };
            let openSet = [startNode];
            let visited = new Set([serialize(initial)]);
            let iterations = 0;

            while(openSet.length > 0 && iterations < 15000) {
                iterations++;
                openSet.sort((a, b) => (a.g + a.h) - (b.g + b.h));
                let curr = openSet.shift();
                if(isWin(curr.s)) return curr.p;

                for(let i=0; i<curr.s.length; i++) {
                    if(curr.s[i].length === 0) continue;
                    for(let j=0; j<curr.s.length; j++) {
                        if(i === j) continue;
                        let from = curr.s[i], to = curr.s[j];
                        if(to.length < CAPACITY && (to.length === 0 || to[to.length-1] === from[from.length-1])) {
                            if (from.length === CAPACITY && new Set(from).size === 1) continue;
                            let nextS = curr.s.map((t, idx) => {
                                if(idx === i) return t.slice(0, -1);
                                if(idx === j) return [...t, from[from.length-1]];
                                return t;
                            });
                            let key = serialize(nextS);
                            if(!visited.has(key)) {
                                visited.add(key);
                                openSet.push({ s: nextS, p: [...curr.p, {f:i, t:j}], g: curr.g + 1, h: getHeuristic(nextS) });
                            }
                        }
                    }
                }
                if (openSet.length > 2500) openSet = openSet.slice(0, 1000);
            }
            return null;
        }

        async function startAiSolver() {
            if(isAiMode || isAnimating) return;
            isAiMode = true;
            const sol = solveGameOptimized(tubesData);
            if(sol) {
                for(let m of sol) {
                    if(!isAiMode) break;
                    selectedIdx = m.f; render(); await new Promise(r=>setTimeout(r, 60));
                    history.push(JSON.stringify(tubesData));
                    await animateBallMove(m.f, m.t);
                    tubesData[m.t].push(tubesData[m.f].pop());
                    moveCount++; updateUI(); selectedIdx = null; playSound('drop'); render();
                    checkWin(); await new Promise(r=>setTimeout(r, 40));
                }
            } else { alert("AI could not find a solution. Try adding a tube!"); }
            isAiMode = false;
        }

        function detectAiTrigger() {
            const now = Date.now();
            if(now - lastAiClick > 800) undoClickCount = 0;
            lastAiClick = now; undoClickCount++;
            if(undoClickCount >= 3) { undoClickCount = 0; startAiSolver(); }
        }

        function detectWinTrigger() {
            timeClickCount++;
            if(timeClickCount >= 3) { timeClickCount = 0; checkWin(true); }
            setTimeout(()=>timeClickCount=0, 800);
        }

        function render() {
            const container = document.getElementById('game-container'); container.innerHTML = '';
            const config = DIFF_SETTINGS[currentDiffIdx];
            const tubeW = config.tubes > 8 ? '48px' : '54px';
            tubesData.forEach((balls, idx) => {
                const t = document.createElement('div');
                t.className = `tube ${selectedIdx === idx ? 'selected' : ''}`;
                t.id = `tube-${idx}`; t.style.width = tubeW;
                t.onclick = () => handleTubeClick(idx);
                balls.forEach(c => { const b = document.createElement('div'); b.className = `ball c-${c}`; t.appendChild(b); });
                container.appendChild(t);
            });
        }

        async function handleTubeClick(idx) {
            if(isAnimating || isAiMode) return;
            if(selectedIdx === null) { if(tubesData[idx].length>0){selectedIdx=idx; playSound('pick'); render();} }
            else {
                const from = tubesData[selectedIdx], to = tubesData[idx];
                if(selectedIdx !== idx && to.length < CAPACITY && (to.length === 0 || to[to.length-1] === from[from.length-1])) {
                    history.push(JSON.stringify(tubesData));
                    await animateBallMove(selectedIdx, idx);
                    to.push(from.pop()); moveCount++; updateUI(); selectedIdx = null; playSound('drop'); render(); checkWin();
                } else { selectedIdx = (tubesData[idx].length>0) ? idx : null; if(selectedIdx!==null) playSound('pick'); render(); }
            }
        }

        async function animateBallMove(fIdx, tIdx) {
            isAnimating = true;
            const ball = document.getElementById(`tube-${fIdx}`).lastElementChild;
            const rect = ball.getBoundingClientRect();
            const dummy = ball.cloneNode(true);
            dummy.style.position = 'fixed'; dummy.style.left = rect.left+'px'; dummy.style.top = rect.top+'px';
            dummy.style.zIndex = '5000'; dummy.style.transition = '0.15s ease-in-out';
            document.body.appendChild(dummy); ball.style.visibility = 'hidden';
            await new Promise(r=>setTimeout(r, 10));
            dummy.style.top = (document.getElementById(`tube-${fIdx}`).getBoundingClientRect().top - 40)+'px';
            await new Promise(r=>setTimeout(r, 150));
            dummy.style.left = (document.getElementById(`tube-${tIdx}`).getBoundingClientRect().left+7)+'px';
            await new Promise(r=>setTimeout(r, 150));
            /* 動畫終點調整至靠近底部的座標 */
            dummy.style.top = (document.getElementById(`tube-${tIdx}`).getBoundingClientRect().bottom - 10 - (tubesData[tIdx].length+1)*41)+'px';
            await new Promise(r=>setTimeout(r, 150));
            dummy.remove(); isAnimating = false;
        }

        function checkWin(force = false) {
            if(force || (tubesData.length > 0 && tubesData.every(t => t.length === 0 || (t.length === CAPACITY && new Set(t).size === 1)))) {
                clearInterval(timerInterval); playSound('win');
                document.getElementById('res-diff').innerText = DIFF_SETTINGS[currentDiffIdx].label;
                document.getElementById('res-time').innerText = document.getElementById('timer').innerText;
                document.getElementById('res-moves').innerText = moveCount;
                document.getElementById('res-undo').innerText = undoTotal;
                document.getElementById('res-extra').innerText = extraUsed > 0 ? "Used" : "Not Used";
                document.getElementById('result-screen').style.display = 'flex';
                isAiMode = false;
            }
        }

        function updateUI() {
            document.getElementById('undo-btn').className = history.length === 0 ? 'btn-undo disabled' : 'btn-undo';
            document.getElementById('moves').innerText = moveCount;
            document.getElementById('undo-now').innerText = undoTotal;
            document.getElementById('extra-now').innerText = `${extraUsed}/1`;
        }

        function startTimer() { clearInterval(timerInterval); timerInterval = setInterval(() => { seconds++; const m = Math.floor(seconds/60).toString().padStart(2,'0'), s = (seconds%60).toString().padStart(2,'0'); document.getElementById('timer').innerText = `${m}:${s}`; }, 1000); }
        function undoMove() { if(history.length>0 && !isAnimating) { tubesData = JSON.parse(history.pop()); undoTotal++; updateUI(); render(); } }
        function addExtraTube() { if(extraUsed === 0) { tubesData.push([]); extraUsed = 1; updateUI(); render(); } }
        
        function toggleDiffMenu() {
            const menu = document.getElementById('diff-overlay');
            if(menu.style.display !== 'flex') {
                const list = document.getElementById('diff-list'); list.innerHTML = '';
                DIFF_SETTINGS.forEach((d, idx) => {
                    const item = document.createElement('div');
                    item.className = `diff-item ${idx === currentDiffIdx ? 'active' : ''}`;
                    item.innerText = d.label;
                    item.onclick = () => { currentDiffIdx = idx; initLevel(); toggleDiffMenu(); };
                    list.appendChild(item);
                });
                menu.style.display = 'flex';
            } else menu.style.display = 'none';
        }

        function toggleHelp() { 
            const h = document.getElementById('help-overlay');
            h.style.display = (h.style.display === 'flex') ? 'none' : 'flex';
        }

        function closeResult() { document.getElementById('result-screen').style.display = 'none'; initLevel(); }
        function toggleSound() { soundEnabled = !soundEnabled; document.getElementById('sound-btn').style.opacity = soundEnabled ? "1" : "0.5"; }
        
        function playSound(type) {
            if(!soundEnabled) return;
            const now = audioCtx.currentTime;
            if(type==='pick'){ const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value=440; g.gain.setValueAtTime(0.1,now); o.start(); o.stop(now+0.1); }
            else if(type==='drop'){ const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value=300; g.gain.setValueAtTime(0.1,now); o.start(); o.stop(now+0.1); }
            else if(type==='win'){ 
                [523, 659, 1046].forEach((f, i) => { 
                    const o = audioCtx.createOscillator(), g = audioCtx.createGain(); 
                    o.connect(g); g.connect(audioCtx.destination); o.frequency.value = f; 
                    g.gain.setValueAtTime(0.1, now + i*0.1); 
                    const dur = i === 2 ? 1.0 : 0.6;
                    g.gain.exponentialRampToValueAtTime(0.001, now + dur);
                    o.start(now + i*0.1); o.stop(now + dur); 
                }); 
            }
        }

        initLevel();
    </script>
</body>
</html>